# tion-grafana-automation

Этот репозиторий содержит дашборд с алертами для Grafana и скрипт вебхука для Grafana Alerting

Скорость приточного вентилятора (Tion S3) выбирается на основе показаний уровня CO2 от датчика MT8057 (ZyAura ZG01C)

Само решение костыльное и я не претендую на профессиональность, код опубликован на случай если кто-то вдохновится сделать решение по-лучше

# Дашборд
В моём дашборде я использую данные из influxdb, которые попадают туда с помощью агента [ambient7](https://github.com/maizy/ambient7#mt8057-agent) (MT8057 подключен к компьютеру по USB, агент собирает данные и присылает их в базу)

Графана не позволяет делать несколько алертов на одном графике, по этому он разбит на три по скоростям бризера:
Диапазон | Скорость
----------- | ------
1200-950ppm | 6
950-700ppm  | 5
650-350ppm  | 4

При переходе выше порога срабатывает алерт, который отправляет вебхук:

Порог | Скорость
------- | ------
1000ppm | 6
700ppm  | 5
600ppm  | 4

![dashboard.png](https://raw.githubusercontent.com/timhok/tion-grafana-automation/main/screenshots/dashboard.png)

Все значения выбраны путём эксперементов

# Алерты

Для работы должен быть настроен канал для уведомлений:
- Тип канала `webhook`
- Url соответстовать схеме `http://<webhook-ip>:8087/grafana_alert`
- Http Method `POST`

![alert_channel.png](https://raw.githubusercontent.com/timhok/tion-grafana-automation/main/screenshots/alert_channel.png)

# webhook.py

Скрипт использует Flask для поднятия сервера вебхука, команды на бризер отправляются с помощью модуля [tion-python](https://github.com/TionAPI/tion_python)

```pip install flask tion-btle```

Последнее состояние скорости хранится в переменной `fan_speed`, что позволяет дёргать бризер как можно меньше.

После срабатывания алерта, команда бризеру не уходит, если скорость:
- Алерт переходит в состояние alerting (превышение порога), а скорость уже была выше или равна задаваемой
- Алерт переходит в состояние ok (значение стало ниже порога), а скорость уже была ниже задаваемой

Перед началом работы нужно поменять в скрипте MAC адрес бризера на ваш, для сопряжения устройства (где будет запущен вебхук) обратитесь к документации модуля [tion-python](https://github.com/TionAPI/tion_python/blob/master/README.md)
